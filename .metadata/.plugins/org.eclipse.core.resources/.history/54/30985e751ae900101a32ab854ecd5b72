package com.history;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.net.URL;
import java.net.URLConnection;
import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.List;
import java.util.Random;

import javax.ejb.Stateful;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.Query;


/**
 * Session Bean implementation class Account
 */
@Stateful(mappedName="History")
public class History implements HistoryRemote {

	
	@PersistenceContext(unitName="history-unit")
	private EntityManager em;


	@Override
	public boolean addLogin1FA(String idPib) {
		long loginTime = System.currentTimeMillis();
		long txnNumber=txnNumberGenerator();
		//System.out.println("inside history.java addLogin1FA");
		
		HistoryClass h = new HistoryClass();
		h.setIdPib(idPib);
		h.setTime(loginTime);
		h.setTxnName("1FA Login");
		h.setTxnNumber(txnNumber);
		em.persist(h);
		return true;
	}

	private long txnNumberGenerator(){
		String numberS = hashGenerator(10);
		long number = Long.parseLong(numberS);
		HistoryClass x = em.find(HistoryClass.class, number);
		while(x!=null){
			System.out.println("<History><txnNumberGenerator>running...");
			numberS = hashGenerator(10);
			number = Long.parseLong(numberS);
			x = em.find(HistoryClass.class, number);	
		}
		return number;
	}
	
	private String hashGenerator(int len){
		String AB = "0123456789";
		Random rnd = new Random();
		StringBuilder sb = new StringBuilder(len);
		for( int i = 0; i < len; i++ ) 
		      sb.append( AB.charAt( rnd.nextInt(AB.length()) ) );		
		return sb.toString();
		
	}
	
	
}

